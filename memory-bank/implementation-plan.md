# 基础游戏实施计划（给 AI 开发者的分步指令）

> 范围：只做“基础游戏”闭环——页面可运行、授权摄像头、手部追踪稳定、3 个核心手势驱动 Tree ⇄ Tornado 的状态与动画、可暂停、可恢复、可在主流浏览器基本可用。  
> 约束：每一步都要小而具体；每一步都必须包含验证测试；不包含任何代码（含代码块/伪代码）。

## 项目约定（防歧义）

- 文档位置：本计划以仓库内 `memory-bank/implementation-plan.md` 为准（single source of truth）。
- 媒体：基础游戏阶段不做上传；允许 UI 按钮占位；Tornado 里的卡片允许纯色/程序纹理。若必须内置素材，统一放到 `src/assets/`。
- 状态机：以 6 态为准（见 GDD）；并且 Tree 与 Tornado 各自有 Pause 变体（不要做“全局 Pause 覆盖一切”的单一态）。
- 坐标与手势：以摄像头坐标为准（优先降低理解负担）；右手优先；pinch→展开进度采用线性映射（暂不做 pinch 防抖/平滑）；open palm 用 toggle（带 cooldown）；swipe 控制旋转速度，范围固定为 0–3 rad/s。
- 性能：以“主观不卡”为最终验收；同时实现简单 FPS 计数器并设定阈值（低于阈值时提示/降级，但不作为硬失败门槛）。
- 性能：以“主观不卡”为最终验收；实现简单 FPS 计数器并设定阈值：**持续低于 45 FPS 时仅提示，不自动降级**。
- 测试：允许“手动测试 + 命令行检查（typecheck/build）”；涉及摄像头/手势的最终目标是“真实手可用”，不强制为其做可在 CI 中运行的硬件依赖测试。
- 画面：显示不做镜像处理，直接输出摄像头画面；手势计算同样以摄像头坐标为准。

## 里程碑定义（完成标准）

- 本地运行：`npm run dev` 可启动；`npm run build` 通过。
- 摄像头：可请求权限；拒绝/无设备时有明确提示且不崩溃。
- 手势（单手即可）：捏合控制展开进度；挥手控制旋转方向与速度；张开手掌进入/退出暂停展示。
- 视觉：Tree 模式可见树；Tornado 模式可见媒体卡片占位（先用内置占位素材，不做上传）。
- 稳定：手势有防抖/冷却；帧率在常见笔记本浏览器下不明显卡顿。

## Step-by-step

### 1) 固化当前基线与验收入口

- 指令：确认现有脚手架能在干净环境下运行；明确“基础游戏”验收 checklist（写到 `AGENTS.md` 或新建 `docs/mvp-checklist.md`）。
- 验证测试：
  - 运行 `npm run typecheck`、`npm run build`，均应成功退出（无错误码）。
  - 打开 `npm run dev` 的页面，确认能看到画面（canvas 有内容）且控制台无报错。

### 2) 增加最小的“调试 HUD”（可开关）

- 指令：在页面提供一个极简 HUD 区域，显示：当前模式（TREE/TRANSFORM/TORNADO/PAUSE）、手部追踪状态（未启动/加载中/已追踪/丢失）、关键数值（展开进度、旋转速度）。
- 验证测试：
  - 手动：刷新页面，HUD 默认可见并显示合理的初始状态。
  - 手动：窗口 resize 后 HUD 仍可见，canvas 渲染不拉伸变形（无明显错位）。

### 3) 建立“输入管线骨架”（先不接模型）

- 指令：按 `tech-stack.md` 的模块建议创建 `src/input/` 目录，定义统一的输入生命周期：初始化、启动、停止、销毁；先用模拟输入（例如鼠标/键盘）驱动状态机，保证不依赖摄像头也能跑通模式切换。
- 验证测试：
  - 手动：在无摄像头权限情况下，仍能通过模拟输入完成 TREE→TRANSFORM→TORNADO→TREE 的循环。
  - 自动/命令：`npm run build` 通过（确保新增模块没有类型错误）。

### 4) 接入摄像头：权限与预览管理

- 指令：实现摄像头启动/停止与错误分支（无设备、权限拒绝、被占用）；提供可选的小预览（可隐藏），并确保停止后释放资源（灯灭、设备不再占用）。
- 验证测试：
  - 手动：首次进入点击“启用摄像头”，浏览器弹权限框；允许后预览画面更新。
  - 手动：点击“停止摄像头”，预览停止且系统摄像头指示灯关闭。
  - 手动：拒绝权限后，页面不崩溃，HUD 显示“权限被拒绝/需授权”。

### 5) 接入 MediaPipe Hands：仅做到“稳定拿到关键点”

- 指令：把 MediaPipe Hands 接到摄像头帧流；只输出“是否检测到手”和“关键点数组是否有效”，不做任何手势逻辑；加上模型加载中的状态提示。
- 验证测试：
  - 手动：允许摄像头后，把手伸入画面，HUD 从“未追踪”变为“已追踪”；移出后回到“丢失”。
  - 手动：反复进出画面 10 次，控制台无异常堆栈、无页面卡死。
  - 命令：`npm run build` 通过。

### 6) 添加“关键点可视化调试层”（仅开发态）

- 指令：在开发模式提供可视化（例如覆盖在视频或 canvas 上），能看见关键点/连接线；用于调参与确认镜像/坐标系正确。
- 验证测试：
  - 手动：手指移动时关键点同步移动、无明显镜像错误（左右手方向与预期一致）。
  - 手动：关闭调试层后性能明显改善或至少不变（主画面不卡顿）。

### 7) 定义手势输入的“稳定信号”（pinch 强度）

- 指令：实现捏合强度的连续值输出（0–1），做线性映射与边界裁剪即可（暂不做平滑/防抖）；定义丢手时的回落策略（避免突然跳变或误触发）。
- 验证测试：
  - 手动：慢慢捏合/松开时，HUD 显示的捏合值单调变化（允许有轻微抖动，但不应频繁跳变到极值）。
  - 手动：手离开画面后，捏合值回到安全默认（例如 0 或保持最后值并逐渐衰减），且不会触发模式乱跳。

### 8) 定义手势输入的“离散事件”（open palm 暂停）

- 指令：实现张开手掌的识别输出为“toggle 暂停”的事件（一次张开只切换一次）；加冷却（例如 300ms+）避免连击。
- 验证测试：
  - 手动：张开手掌保持 1 秒，只应触发一次进入暂停；收回再张开才触发下一次。
  - 手动：在暂停状态下，旋转停止；退出暂停后恢复。

### 9) 定义手势输入的“速度事件”（swipe 旋转）

- 指令：实现水平挥手的方向与强度（速度）估计；给出阈值与冷却；把结果映射到 0–3 rad/s 的旋转速度（或其增量），不要直接操作 Three.js 对象。
- 验证测试：
  - 手动：向右挥手会让旋转加速/顺时针；向左挥手反向或减速（按你定义的映射一致即可）。
  - 手动：轻微抖动不会误触发挥手；连续快速挥动不会让速度无限增长（有上限）。

### 10) 明确状态机：输入→意图→模式

- 指令：把所有输入汇总为“意图变量”（展开进度、旋转速度、暂停标志），由状态机统一裁决模式切换；以 6 态为准，并确保 Tree 与 Tornado 各自有 Pause 变体；定义清晰的阈值（例如 progress < 0.1 为 Tree 侧，>0.9 为 Tornado 侧，中间为 Transform 侧）。
- 验证测试：
  - 手动：用捏合控制展开，从 TREE 平滑过渡到 TORNADO，再收拢回 TREE；过程中模式显示正确、不会来回抖动。
  - 手动：丢手 2 秒内，模式不会突然跳到另一个模式（策略需一致且可解释）。

### 11) 场景拆分：Tree 与 Tornado 的独立“可见性/权重”

- 指令：将 Tree 与 Tornado 视为两个可独立显示的场景对象，通过 `transformProgress` 混合（例如 Tree 逐渐淡出/缩小，Tornado 逐渐显现/放大）；先用简单效果，不追求最终美术。
- 验证测试：
  - 手动：展开进度从 0→1 时，两种形态都按预期变化且无突兀闪烁。
  - 手动：频繁来回捏合（10 次）不出现对象丢失、穿帮到 NaN、或渲染崩溃。

### 12) Tornado “媒体卡片占位”渲染（不做上传）

- 指令：先用占位卡片（纯色/程序纹理/文本均可），实现螺旋/环形布局与随时间旋转；数量设上限（例如 40–80）并可在 HUD 调整。若必须内置素材，统一放在 `src/assets/`。
- 验证测试：
  - 手动：进入 TORNADO 后能看到卡片阵列，旋转方向与状态机一致。
  - 手动：把卡片数量调到上限，仍能保持可用帧率（主观不卡到不可玩）。
  - 命令：`npm run build` 通过。

### 13) 暂停（PAUSE）模式的渲染与交互规则

- 指令：定义暂停时哪些动画停止（至少停止旋转），哪些仍保留（例如轻微呼吸）；输入仍处理但不改变场景对象，直到退出暂停。
- 验证测试：
  - 手动：进入暂停后，旋转立刻停止且保持稳定画面；退出后继续旋转，不会突然跳帧或爆速。

### 14) 错误与降级：无 WebGL/低性能设备

- 指令：增加能力检测与降级策略：WebGL 不可用时显示明确提示；低性能时降低 DPR 或减少卡片数量（可自动触发）。
- 验证测试：
  - 手动：在开发者工具模拟低性能（或把 DPR/卡片数调高再触发降级），确认能自动回落到可运行配置。
  - 手动：禁用 WebGL（或用不支持环境）时，不出现白屏无提示。

### 14.1) FPS 计数器与阈值提示（非硬门槛）

- 指令：增加简单 FPS 计数器（显示当前 FPS 与“低于阈值”的提示）；当持续低于 45 FPS 时仅提示，不自动触发降级。
- 验证测试：
  - 手动：在正常环境下 FPS 数值持续更新；不会明显增加卡顿。
  - 手动：通过提升负载（例如把卡片数拉满）触发“低于阈值”提示；确认不会自动改变 DPR/卡片数量等配置。

### 15) 增加基础自动化测试框架（只覆盖“基础闭环”）

- 指令：引入轻量测试：至少包含
  - 逻辑单测：覆盖状态机阈值、模式切换防抖策略、旋转速度上限裁剪。
  - 页面烟雾：验证页面能加载并存在 `#scene`，且渲染循环已启动（用最小可行断言）。
- 验证测试：
  - 命令：新增 `npm run test` 后可一键运行并通过。
  - 手动：在无摄像头权限环境下，测试仍可通过（避免依赖真实硬件）；真实手追踪以手动回归为准。

### 16) 回归与打包验收（基础游戏交付）

- 指令：按里程碑 checklist 做一次完整回归；整理 README 或 docs，写清“如何运行、如何启用摄像头、手势怎么玩、已知限制”。
- 验证测试：
  - 命令：`npm run typecheck`、`npm run build`、`npm run test` 全通过。
  - 手动：Chrome + Safari（或 iOS Safari）至少各跑一遍：授权→追踪→展开→旋转→暂停→收拢，全流程无崩溃。

## 后续功能（先不做，只记录排队）

- 上传图片/GIF/视频与纹理生命周期管理（缓存、释放、大小限制）。
- 录屏导出（`MediaRecorder`）与分享。
- 更精致的树模型、灯光与转场特效（Bloom/粒子）。
- 多人/联机/皮肤系统。
